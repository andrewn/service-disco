<!DOCTYPE html>
<html>
  <head>
    <script src='lib/ractive.js'></script>
    <script src='lib/lodash.min.js'></script>
    <script src='lib/moment.min.js'></script>
    <link rel="stylesheet" type="text/css" href="lib/pure.min.css">
    <link rel="stylesheet" type="text/css" href="lib/grids-responsive-min.css">
    <style type="text/css">
    * {
      font-weight: 200;
    }

    table {
      width: 100%;
    }

    tr:hover td {
      background-color #eee;
    }

    .sortable {
      cursor: pointer;
    }

    .sorted {
      background-color: #ccc;
    }

    header {
      padding: 1em;
    }

    h1 {
      color: #666;
    }

    h1 > span {
      color: #000;
    }

    .panel > * {
      display: inline-block;
      vertical-align: middle;
    }

    .buttons {
      padding-left: 3em;
    }

    .dancer {
      margin-left: -2em;
      height: 8em;
    }

    .disco {
      margin-top: -15em;
      height: 5em;
      transition: margin-top 0.3s ease-in-out;
    }

    .is-scanning .disco {
      margin-top: -6em;
    }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body class="pure-g">
    <header class="pure-u-5-5">
      <div class="pure-g">
        <div class="panel pure-u-4-5">
          <img class="icon disco" src="disco.svg" />
          <img class="icon dancer" src="icon.svg" />
          <h1>
            Service <span>Disco</span>very
          </h1>
          <div class="buttons">
            <button class="pure-button pure-button-primary button-xsmall" on-click="scan">
              Scan
            </button>
          </div>
        </div>
      </div>
    </header>
    <div id="container" class="pure-u-5-5"></div>

    <script id='template' type='text/ractive'>
      <table class="pure-table pure-table-horizontal">
        <thead>
          <tr>
            <th class="sortable {{ sortColumn == 'state' ? 'sorted' : ''  }}" 
                on-click="sort:state">State</th>
            <th class="sortable {{ sortColumn == 'id' ? 'sorted' : ''     }}" 
                on-click="sort:id">ID</th>
            <th class="sortable {{ sortColumn == 'type' ? 'sorted' : ''   }}" 
                on-click="sort:type">Type</th>
            <th class="sortable {{ sortColumn == 'server' ? 'sorted' : '' }}" 
                on-click="sort:server">Server</th>
            <th class="sortable {{ sortColumn == 'lastMessage' ? 'sorted' : '' }}" 
                on-click="sort:lastMessage">Last seen</th>
            <th class="sortable {{ sortColumn == 'location' ? 'sorted' : '' }}" 
                on-click="sort:location">Location</th>
            <th class="sortable {{ sortColumn == 'protocol' ? 'sorted' : '' }}" 
                on-click="sort:protocol">Protocol</th>
          </tr>
        </thead>
        {{# sort(services, sortColumn) }}
          <tr class="{{state}}">
            <td>{{ state }}</td>
            <td>{{ id }}</td>
            <td>{{ type }}</td>
            <td>{{ server }}</td>
            <td><time datetime={{ timestamp }}>{{ time(timestamp) }}</time></td>
            <td><a href="{{ location }}">{{location}}</a></td>
            <td>{{ protocol }}</td>
          </tr>
        {{/services}}
      </table>
    </script>

    <script type="text/javascript">

      var table = new Ractive({
        el: 'container',
        template: '#template',
        data: { 
          services: [], 
          sortColumn: 'state',
          sort: function ( array, column ) {
            array = array.slice(); // clone, so we don't modify the underlying data

            return array.sort( function ( a, b ) {
              return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          time: function (date) {
            return moment(date).format('HH:mm:ss');
          },
          ago: function (date) {
            return moment(date).fromNow();
          }
        }
      });

      /*
        Trigger a scan when button is pressed
      */
      document.querySelector('button')
              .addEventListener('click', scan);

      var isScanningId;

      function isScanning() {
        if (isScanningId) { return; }

        document.querySelector('body')
                .classList
                .add('is-scanning');

        isScanningId = window.setTimeout(function () {
          document.querySelector('body')
                  .classList.remove('is-scanning');
          isScanningId = null;
        }, 1000);
      }

      function scan () {
        var img = new Image();
        img.src = '/scan';
        isScanning();
      };

      var services = table.get('services');

      var stream = new EventSource('/events');
      stream.addEventListener('message', function (evt) {
        isScanning();

        var json = JSON.parse(evt.data);
        console.log('message', json);

        var service = _.find(services, { id: json.id });

        if (service) {
          service.seen = json.timestamp;
          service.state = json.state;

          if(json.location) {
            service.location = json.location;
          }

          if(json.server) {
            service.server = json.server;
          }

          table.update();
        } else {
          services.push(json);
        }        
      });
    </script>
  </body>
</html>